@{
    ViewData["Title"] = "Reddit Istemcisi";
}

<h4 class="py-3 mb-4">
    <span class="text-muted fw-light">API Entegrasyonlari /</span> Reddit Istemcisi
</h4>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bx bxl-reddit text-danger me-2"></i>Reddit Istemcisi
                </h5>
            </div>
            <div class="card-body">
                <!-- Subreddit Arama -->
                <div class="input-group mb-4">
                    <span class="input-group-text">r/</span>
                    <input type="text" class="form-control" id="subredditInput"
                           placeholder="subreddit adi (ornek: webdev)" value="webdev">
                    <button class="btn btn-danger" onclick="loadPosts()">
                        <i class="bx bx-search"></i> Getir
                    </button>
                </div>

                <!-- Yukleniyor -->
                <div id="loading" class="text-center py-4 d-none">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Yukleniyor...</span>
                    </div>
                    <p class="text-muted mt-2">Gonderiler yukleniyor...</p>
                </div>

                <!-- Hata Mesaji -->
                <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>

                <!-- Gonderiler -->
                <div id="posts">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Populer Subredditler -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Populer Subredditler</h6>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('programming')">programming</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('webdev')">webdev</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('javascript')">javascript</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('python')">python</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('csharp')">csharp</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('technology')">technology</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('learnprogramming')">learnprogramming</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="quickSearch('dataisbeautiful')">dataisbeautiful</button>
                </div>
            </div>
        </div>

        <!-- Siralama -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Siralama</h6>
            </div>
            <div class="card-body">
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="sort" id="sortHot" value="hot" checked>
                    <label class="btn btn-outline-danger" for="sortHot">Hot</label>

                    <input type="radio" class="btn-check" name="sort" id="sortNew" value="new">
                    <label class="btn btn-outline-danger" for="sortNew">New</label>

                    <input type="radio" class="btn-check" name="sort" id="sortTop" value="top">
                    <label class="btn btn-outline-danger" for="sortTop">Top</label>
                </div>
            </div>
        </div>

        <!-- Bilgi -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Bilgi</h6>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-0">
                    Bu uygulama Reddit'in public JSON API'sini kullanmaktadir.
                    Kimlik dogrulamasi gerektirmez ve sadece okuma islemleri yapar.
                </p>
            </div>
        </div>
    </div>
</div>

@section PageScripts {
<script>
    const subredditInput = document.getElementById('subredditInput');
    const postsContainer = document.getElementById('posts');
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('errorMessage');

    // Enter ile arama
    subredditInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadPosts();
    });

    // Siralama degistiginde yeniden yukle
    document.querySelectorAll('input[name="sort"]').forEach(radio => {
        radio.addEventListener('change', loadPosts);
    });

    async function loadPosts() {
        const subreddit = subredditInput.value.trim();
        if (!subreddit) return;

        const sort = document.querySelector('input[name="sort"]:checked').value;

        // UI guncelle
        loading.classList.remove('d-none');
        postsContainer.innerHTML = '';
        errorMessage.classList.add('d-none');

        try {
            const response = await fetch(`https://www.reddit.com/r/${subreddit}/${sort}.json?limit=15`);

            if (!response.ok) {
                throw new Error('Subreddit bulunamadi');
            }

            const data = await response.json();

            if (!data.data || !data.data.children || data.data.children.length === 0) {
                throw new Error('Gonderi bulunamadi');
            }

            renderPosts(data.data.children);

        } catch (error) {
            errorMessage.textContent = error.message || 'Bir hata olustu';
            errorMessage.classList.remove('d-none');
        } finally {
            loading.classList.add('d-none');
        }
    }

    function renderPosts(posts) {
        postsContainer.innerHTML = posts.map(post => {
            const p = post.data;
            const isNsfw = p.over_18;
            const hasImage = p.thumbnail && p.thumbnail.startsWith('http');

            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex">
                            ${hasImage && !isNsfw ? `
                                <img src="${p.thumbnail}" alt="" class="rounded me-3"
                                     style="width: 80px; height: 80px; object-fit: cover;">
                            ` : ''}
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">
                                    ${isNsfw ? '<span class="badge bg-danger me-1">NSFW</span>' : ''}
                                    ${escapeHtml(p.title)}
                                </h6>
                                <div class="d-flex flex-wrap gap-2 text-muted small mb-2">
                                    <span><i class="bx bx-like me-1"></i>${p.ups.toLocaleString('tr-TR')}</span>
                                    <span><i class="bx bx-comment me-1"></i>${p.num_comments.toLocaleString('tr-TR')}</span>
                                    <span><i class="bx bx-user me-1"></i>u/${p.author}</span>
                                </div>
                                <a href="https://reddit.com${p.permalink}" target="_blank"
                                   class="btn btn-sm btn-outline-danger">
                                    Reddit'te Gor
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function quickSearch(subreddit) {
        subredditInput.value = subreddit;
        loadPosts();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Sayfa yuklendiginde varsayilan subredditi yukle
    loadPosts();
</script>
}
